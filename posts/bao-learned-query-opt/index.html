<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Paper Reading: Bao: Making Learned Query Optimization Practical [SIGMOD 21] - Adbean&#39;s Blog</title><meta name="Description" content="Adbean&#39;s Blog"><meta property="og:url" content="https://ad-bean.github.io/posts/bao-learned-query-opt/">
  <meta property="og:site_name" content="Adbean&#39;s Blog">
  <meta property="og:title" content="Paper Reading: Bao: Making Learned Query Optimization Practical [SIGMOD 21]">
  <meta property="og:description" content="Bao: Making Learned Query Optimization Practical MLDB &#43; query optimization ABSTRACT æœ€è¿‘ ML åš query optimization ç”±äºéœ€è¦ substantive training overhead æ‰€ä»¥å…¶å®å¾ˆå°‘ practical gains, inability to adapt to changes, poor tail performance. è®ºæ–‡æå‡ºäº† Bao, Bandit Optimizer, é€šè¿‡åˆ©ç”¨ç°æœ‰æŸ¥è¯¢ä¼˜åŒ–å™¨çš„çŸ¥è¯†ï¼Œå¯¹æ¯ä¸ªæŸ¥è¯¢æä¾›">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-03-17T00:14:24-04:00">
    <meta property="article:modified_time" content="2024-03-17T00:14:24-04:00">
    <meta property="article:tag" content="Paper Reading">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Paper Reading: Bao: Making Learned Query Optimization Practical [SIGMOD 21]">
  <meta name="twitter:description" content="Bao: Making Learned Query Optimization Practical MLDB &#43; query optimization ABSTRACT æœ€è¿‘ ML åš query optimization ç”±äºéœ€è¦ substantive training overhead æ‰€ä»¥å…¶å®å¾ˆå°‘ practical gains, inability to adapt to changes, poor tail performance. è®ºæ–‡æå‡ºäº† Bao, Bandit Optimizer, é€šè¿‡åˆ©ç”¨ç°æœ‰æŸ¥è¯¢ä¼˜åŒ–å™¨çš„çŸ¥è¯†ï¼Œå¯¹æ¯ä¸ªæŸ¥è¯¢æä¾›">
<meta name="application-name" content="Adbean&#39;s Blog">
<meta name="apple-mobile-web-app-title" content="Adbean&#39;s Blog"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="icon" href="../../Owl.ico"><link rel="apple-touch-icon" sizes="180x180" href="../../apple-touch-icon.png"><link rel="mask-icon" href="../../safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="../../site.webmanifest"><link rel="canonical" href="https://ad-bean.github.io/posts/bao-learned-query-opt/" /><link rel="prev" href="https://ad-bean.github.io/posts/zero-shot-learned/" /><link rel="next" href="https://ad-bean.github.io/posts/minilsm-1/" /><link rel="stylesheet" href="../../css/style.min.css"><link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"></noscript><link rel="preload" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Paper Reading: Bao: Making Learned Query Optimization Practical [SIGMOD 21]",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/ad-bean.github.io\/posts\/bao-learned-query-opt\/"
        },"genre": "posts","keywords": "Paper Reading","wordcount":  3827 ,
        "url": "https:\/\/ad-bean.github.io\/posts\/bao-learned-query-opt\/","datePublished": "2024-03-17T00:14:24-04:00","dateModified": "2024-03-17T00:14:24-04:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "Adbean"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="../../" title="Adbean&#39;s Blog"><img
        class="lazyload logo"
        src="../../svg/loading.min.svg"
        data-src="../../Owl.ico"
        data-srcset="../../Owl.ico, ../../Owl.ico 1.5x, ../../Owl.ico 2x"
        data-sizes="auto"
        alt="/Owl.ico"
        title="/Owl.ico" />Adbean&#39;s Blog</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="../../"> ä¸»é¡µ </a><a class="menu-item" href="../../posts/"> æ–‡ç«  </a><a class="menu-item" href="../../tags/"> æ ‡ç­¾ </a><a class="menu-item" href="../../categories/"> åˆ†ç±» </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="æœç´¢æ–‡ç« æ ‡é¢˜æˆ–å†…å®¹..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="æœç´¢">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="æ¸…ç©º">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="åˆ‡æ¢ä¸»é¢˜">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="../../" title="Adbean&#39;s Blog"><img
        class="lazyload logo"
        src="../../svg/loading.min.svg"
        data-src="../../Owl.ico"
        data-srcset="../../Owl.ico, ../../Owl.ico 1.5x, ../../Owl.ico 2x"
        data-sizes="auto"
        alt="/Owl.ico"
        title="/Owl.ico" />Adbean&#39;s Blog</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="æœç´¢æ–‡ç« æ ‡é¢˜æˆ–å†…å®¹..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="æœç´¢">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="æ¸…ç©º">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        å–æ¶ˆ
                    </a>
                </div><a class="menu-item" href="../../" title="">ä¸»é¡µ</a><a class="menu-item" href="../../posts/" title="">æ–‡ç« </a><a class="menu-item" href="../../tags/" title="">æ ‡ç­¾</a><a class="menu-item" href="../../categories/" title="">åˆ†ç±»</a><a href="javascript:void(0);" class="menu-item theme-switch" title="åˆ‡æ¢ä¸»é¢˜">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">ç›®å½•</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Paper Reading: Bao: Making Learned Query Optimization Practical [SIGMOD 21]</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://github.com/ad-bean" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>Adbean</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2024-03-17">2024-03-17</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;çº¦ 3827 å­—&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;é¢„è®¡é˜…è¯» 8 åˆ†é’Ÿ&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>ç›®å½•</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#bao-making-learned-query-optimization-practical">Bao: Making Learned Query Optimization Practical</a></li>
    <li><a href="#abstract">ABSTRACT</a></li>
    <li><a href="#introduction">INTRODUCTION</a></li>
    <li><a href="#system-model">SYSTEM MODEL</a></li>
    <li><a href="#selecting-query-hints">SELECTING QUERY HINTS</a>
      <ul>
        <li><a href="#predictive-model">Predictive model</a></li>
        <li><a href="#training-loop">Training loop</a></li>
      </ul>
    </li>
    <li><a href="#postgresql-integration">POSTGRESQL INTEGRATION</a></li>
    <li><a href="#related-works">RELATED WORKS</a></li>
    <li><a href="#experiments">EXPERIMENTS</a>
      <ul>
        <li><a href="#setup">Setup</a></li>
      </ul>
    </li>
    <li><a href="#conclusion-and-future-work">CONCLUSION AND FUTURE WORK</a></li>
    <li><a href="#paer-reading">Paer Reading</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h2 id="bao-making-learned-query-optimization-practical">Bao: Making Learned Query Optimization Practical</h2>
<p>MLDB + query optimization</p>
<h2 id="abstract">ABSTRACT</h2>
<p>æœ€è¿‘ ML åš query optimization ç”±äºéœ€è¦ substantive training overhead æ‰€ä»¥å…¶å®å¾ˆå°‘ practical gains, inability to adapt to changes, poor tail performance.</p>
<p>è®ºæ–‡æå‡ºäº† Bao, Bandit Optimizer, é€šè¿‡åˆ©ç”¨ç°æœ‰æŸ¥è¯¢ä¼˜åŒ–å™¨çš„çŸ¥è¯†ï¼Œå¯¹æ¯ä¸ªæŸ¥è¯¢æä¾›ä¼˜åŒ–å»ºè®®ã€‚</p>
<p>Bao combines mordern tree Convolutional Neural Networks (CNN) with Thompson sampling (RL). Bao å¯ä»¥ä»é”™è¯¯ä¸­å­¦ä¹ ï¼Œé€‚åº”ä¸åŒçš„ query workloads, data, schema.</p>
<p>å®éªŒç»“æœæ˜¾ç¤º BAO å¯ä»¥å¿«é€Ÿå­¦ä¹ æ”¹å–„<strong>ç«¯åˆ°ç«¯</strong>æŸ¥è¯¢æ‰§è¡Œæ€§èƒ½ï¼ˆåŒ…æ‹¬ tail latencyï¼‰çš„ç­–ç•¥ï¼Œç”¨äºå‡ ç§åŒ…å« long-term æŸ¥è¯¢çš„å·¥ä½œè´Ÿè½½ã€‚åœ¨<strong>äº‘ç¯å¢ƒ</strong>ä¸­ï¼Œæˆ‘ä»¬è¡¨æ˜ï¼Œä¸å•†ä¸šç³»ç»Ÿç›¸æ¯”ï¼ŒBAO å¯ä»¥æä¾›é™ä½çš„æˆæœ¬å’Œæ›´å¥½çš„æ€§èƒ½ã€‚</p>
<blockquote>
<p>é•¿å°¾è¯·æ±‚ï¼šP99, 99% è¯·æ±‚åœ¨ä¸€å®šè€—æ—¶å†…ï¼Œé•¿å°¾è¯·æ±‚å°±æ˜¯æ˜æ˜¾é«˜äºå‡å€¼çš„é‚£éƒ¨åˆ†æ¯”è¾ƒå°çš„è¯·æ±‚</p>
</blockquote>
<h2 id="introduction">INTRODUCTION</h2>
<p>Query Optimization, cardinality estimation and cost modeling, difficult to crack</p>
<p>å¾ˆå¤š Query Optimization éƒ½æ˜¯ ML åšçš„ï¼Œä½†å´æ˜¯å¾ˆå°‘å®ç”¨ï¼š</p>
<ol>
<li>Long training time, impractical amount of training data, ML-powered cardinality estimators based on supervised learning éœ€è¦æ”¶é›†ç²¾ç¡®çš„ cardinalitiesï¼Œéå¸¸æ˜‚è´µçš„æ“ä½œã€‚æ‰€ä»¥ Bao wish to estimate cardinalities in the first place. RL ä¹Ÿéœ€è¦å¥½å‡ å¤©çš„è®­ç»ƒã€‚</li>
<li>Inability to adjust to data and workload changes. query workload, data, schema æ˜¯ä¼šå˜çš„ï¼Œcardinality estimators based on supervised learning å°±éœ€è¦é‡æ–°è®­ç»ƒï¼Œä¸ç„¶å°±è¿‡æ—¶äº†ã€‚</li>
<li>Tail catastrophe. learning techniques æ¯” traditional optimizers å¹³å‡è¡¨ç°æ›´å¥½ï¼Œä½†æ˜¯é•¿å°¾è¡¨ç°å¾ˆå·® ï¼ˆ100x regression in query performanceï¼‰ã€‚å°¤å…¶æ˜¯è®­ç»ƒæ•°æ®ä¸è¶³æ—¶ï¼ŒåŒæ—¶ç»Ÿè®¡å’Œç°å®è¿˜æ˜¯å…·æœ‰å·®è·.</li>
<li>Black-box decisions. DL æ–¹æ³•æ˜¯é»‘ç›’? ä¸ä¼ ç»Ÿä¼˜åŒ–å™¨ä¸åŒ, å½“å‰å­¦åˆ°çš„ä¼˜åŒ–æ–¹æ³•ä¸èƒ½ç»™ DBA æä¾›æ–¹æ³•</li>
<li>Integration cost. å¤§éƒ¨åˆ† learned optimizers éƒ½æ˜¯ç ”ç©¶åŸå‹, å¾ˆå°‘ç»“åˆ DBMS.</li>
</ol>
<p>Bao å…‹æœäº†ä¸Šé¢çš„é—®é¢˜ï¼Œå¯ä»¥é›†æˆåˆ° PostgreSQLï¼Œhttps://github.com/learnedsystems/baoforpostgresql</p>
<p>æ ¸å¿ƒæ€æƒ³ï¼šé¿å… learning an optimizer from scratchã€‚ take an existing optimizer (PostgreSQLâ€™s
optimizer), and learn when to activate (or deactivate) some of its features on a query-by-query basis. In other words, Bao is a learned component that <strong>sits on top of an existing query optimizer</strong> in order to enhance query optimization, rather than replacing or discarding the traditional query optimizer altogether</p>
<blockquote>
<p>åœ¨ PostgreSQL ä¼˜åŒ–å™¨ä¹‹ä¸Šå¼€å§‹åšä¼˜åŒ–ï¼Œé‚£å¦‚æœä¹‹å‰çš„ä¼˜åŒ–å™¨ä¸å†æ›´æ–°ï¼Œåˆæˆ–è€…æ›´å¥½çš„ä¼˜åŒ–å™¨å‡ºç°äº†æ€ä¹ˆåŠå‘¢ï¼Ÿ</p>
</blockquote>
<p>PostgreSQL optimizer might <strong>underestimate the cardinality</strong> for some joins and wrongly select a loop join when other join algorithms (e.g., merge join, hash join) would be more effective
This occurs in query 16b of the <strong>Join Order Benchmark</strong> (JOB)ï¼Œ and disabling loop-joins for this query yields a 3ğ‘¥ performance improvement (see Figure 1). Yet, it would be wrong to always disable loop joins. For example, for query 24b, disabling loop joins causes the performance to degrade by almost 50ğ‘¥, an arguably catastrophic regression.</p>
<p><img
        class="lazyload"
        src="../../svg/loading.min.svg"
        data-src="https://s2.loli.net/2024/03/17/LGqXZjPCFvBbWOp.png"
        data-srcset="https://s2.loli.net/2024/03/17/LGqXZjPCFvBbWOp.png, https://s2.loli.net/2024/03/17/LGqXZjPCFvBbWOp.png 1.5x, https://s2.loli.net/2024/03/17/LGqXZjPCFvBbWOp.png 2x"
        data-sizes="auto"
        alt="https://s2.loli.net/2024/03/17/LGqXZjPCFvBbWOp.png"
        title="https://s2.loli.net/2024/03/17/LGqXZjPCFvBbWOp.png" /></p>
<p>Bao assumes a <strong>finite set of hint sets</strong> and treats each hint set as an arm in a contextual multi-armed bandit problem.</p>
<blockquote>
<p>multi-armed bandit problem å¤šè‡‚èµŒåšæœºé—®é¢˜ï¼Œæœºå™¨å­¦ä¹ é—®é¢˜ï¼Œæ¯ä¸ªè€è™æœºèµ¢çš„æ¦‚ç‡ä¸ä¸€æ ·ï¼Œä¸çŸ¥é“æ¦‚ç‡ï¼Œé€‰æ‹©å“ªä¸ªèƒ½åšåˆ°æœ€å¤§æ”¶ç›Šï¼Ÿ</p>
</blockquote>
<p>Bao learns a model that predicts <strong>which hints will lead to good performance</strong> for a <strong>particular query</strong>. When a query arrives, our system <strong>selects a hint set</strong>, executes the resulting query plan, and observes a reward. Over time, Bao refines its model to <strong>more accurately</strong> predict which hint set will most benefit an incoming query. For example, for a highly selective query, Bao can automatically steer an optimizer towards a left-deep loop join plan (by restricting the optimizer from using hash or merge joins), and to disable loop joins for less selective queries</p>
<p>By formulating the problem as a <strong>contextual multi-armed bandit</strong>, Bao can take advantage of Thompson sampling, a <strong>well-studied sample efficient algorithm</strong></p>
<p>Because Bao uses an underlying query optimizer, Bao has <strong>cardinality estimates</strong> available, allowing Bao to <strong>adapt to new data and schema changes</strong> just as well as the underlying optimizer. å…¶ä»– learned query optimization éœ€è¦é‡æ–°å­¦ä¹  ä¼ ç»Ÿä¼˜åŒ–å™¨ å·²çŸ¥çš„ä¿¡æ¯ï¼ŒBao å¯ä»¥ç›´æ¥å¼€å§‹å­¦ä¹ æ€ä¹ˆå»è°ƒä¼˜åº•å±‚ä¼˜åŒ–å™¨ï¼Œå¹¶ä¸”ç›¸è¾ƒäºä¼ ç»Ÿä¼˜åŒ–å™¨å¯ä»¥å‡å°‘ tail latencyã€‚</p>
<ol>
<li>Short training time, 1 hour, by taking full advantage of existing query optimization knowledge, which was encoded by human experts into traditional optimizers available in DBMSes today</li>
<li>Robustness to schema, data, and workload changes, maintain performance even in the presence of workload, data, and schema changes, leveraging a <strong>traditional query optimizerâ€™s cost</strong> and <strong>cardinality estimates</strong></li>
<li>Better tail latency, Bao is capable of <strong>improving tail performance</strong> by orders of magnitude with as little as 30 minutes to a few hours of training</li>
<li>Interpretability and easier debugging, be inspected using standard tools,</li>
<li>Low integration cost, every SQL</li>
<li>Extensibility, adding new query hints over time, w/o retraining. Additionally, Baoâ€™s feature representation can be <strong>easily augmented</strong> with <strong>additional information</strong> which can be taken into account during optimization, although this does require <strong>retraining</strong>. cache state</li>
</ol>
<p>drawback:</p>
<p>query optimization time increases, Bao must run the traditional query optimizer several times for each incoming query.
for very short running queries,</p>
<ul>
<li>Bao is ideally suited to workloads that are <strong>tail-dominated</strong> (80% of query processing time is spent processing 20% of the queries) or contain many long-running queries,</li>
<li>limited set of hints, Bao has a <strong>restricted action space</strong>, Bao is not always able to learn the best possible query plan.</li>
<li>outperform <strong>traditional optimizers</strong> while training and adjusting to change orders-of-magnitudes faster than â€œunrestrictedâ€ learned query optimizers, like Neo</li>
</ul>
<blockquote>
<p>Neo ä¹Ÿæ˜¯å¼ºåŒ–å­¦ä¹  + DNNï¼Œä¹Ÿæ˜¯ç”¨ PG ä¼˜åŒ–å™¨é€šè¿‡è®­ç»ƒç„¶ååšä¸€äº›è´ªå¿ƒæœç´¢å¾—åˆ°ä¸€äº›è®¡åˆ’ã€‚å¯èƒ½æ˜¯ query-level çš„ç¼–ç æˆ–è€… plan-level çš„ç¼–ç ä¸åŒï¼Œæ¯”å¦‚è°“è¯çš„è¡¨ç¤ºå€Ÿé‰´äº† word2vec æ•æ‰ rows ä¹‹é—´ç›¸å…³æ€§ï¼Œä¹Ÿç”¨äº† tree DNN æ¥è®­ç»ƒï¼Œvalue model äººä¸ºè®¾è®¡ cost é¢„æµ‹ latencyï¼Œä½†éœ€è¦ä¸æ–­è¿­ä»£ï¼Œå¯¹ ad-hoc æ²¡æœ‰å¤ªå¤§å¸®åŠ©ã€‚</p>
</blockquote>
<p>summary:</p>
<ol>
<li>We introduce Bao, a <strong>learned system</strong> for <strong>query optimization</strong> that is capable of <strong>learning how to apply query hints on a case-by-case basis</strong></li>
<li>For the first time, we demonstrate a learned query optimization system that outperforms both open source and commercial systems in <strong>cost and latency</strong>, all while <strong>adapting to changes in workload, data, and schema</strong>.</li>
</ol>
<h2 id="system-model">SYSTEM MODEL</h2>
<p>Bao combines a <strong>tree convolution model</strong>, a <strong>neural network operator</strong> that can recognize important patterns in query plan trees, with Thompson sampling (solving contextual multi-armed bandit problems)</p>
<ol>
<li><strong>Generating ğ‘› query plans</strong>: When a user submits a query, Bao uses the underlying query optimizer to produce ğ‘› query plans, one for each set of hint. While some hints can be applied to a single relation or predicate, Bao focuses <strong>only on query hints that are a boolean flag</strong> (e.g., disable loop join, force index usage). The sets of hints available to Bao <strong>must be specified upfront</strong>, empty -&gt; original optimizer</li>
<li><strong>Estimating the run-time</strong> for each query plan: Afterwards, each query plan is transformed into a <strong>vector tree</strong> (a tree where each node is a feature vector) -&gt; value model(tree convolutional neural network) -&gt; which <strong>predicts</strong> the quality (e.g., execution time) of each plan -&gt; parallel</li>
<li>Selecting a query plan for execution: best expected performance -&gt; standard supervised fashion and pick the query plan with the best predicted performance. However, <strong>value model</strong> might be wrong, <strong>might not always pick the optimal plan</strong> and never try <strong>alternative strategies</strong> never learn when we are wrong. Thompson sampling explore a specific query offline and guarantee that only the best plan is selected. Once the query execution is complete, the <strong>combination of the selected query plan</strong> and the <strong>observed performance</strong> is added to Baoâ€™s experience. Periodically, this experience is used to retrain the predictive model, creating a feedback loop</li>
<li>Assumptions and Limitations: assumes <strong>hints</strong> result in semantically equivalent <strong>query plans</strong>, Bao always uses the hints for the <strong>entire query plan</strong>. Bao cannot restrict features for <strong>only a part of a query plan</strong>. RL converge -&gt; small size of action</li>
</ol>
<blockquote>
<p>Bao çš„ vaule model æ°¸è¿œä¸ä¼šä»é”™è¯¯ä¸­å­¦ä¹ ï¼Ÿè€Œä¸”çœ‹ä¸Šå»ä¸æ”¯æŒ subquery ä¼˜åŒ–ï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯æ—¶é—´å¤æ‚åº¦å¤ªé«˜çš„åŸå› ã€‚</p>
</blockquote>
<h2 id="selecting-query-hints">SELECTING QUERY HINTS</h2>
<p>Baoâ€™s learning approach, optimization goal, formalize it as a contextual <strong>multi-armed bandit problem.</strong>, apply Thompson sampling, a classical technique used to solve such problems</p>
<p>Bao models each hint set in the family of hint sets</p>
<p>Bao also assumes a user-defined performance metric ğ‘ƒ</p>
<p>Contextual multi-armed bandits (CMABs):</p>
<p>Thompson sampling:</p>
<blockquote>
<p>RL çš„ä¸€äº›ä¸œè¥¿ï¼Œä¸çœ‹äº†</p>
</blockquote>
<h3 id="predictive-model">Predictive model</h3>
<p>The core of Thompson sampling, Baoâ€™s algorithm for selecting hint sets on a per-query basis, is a predictive model that estimates the performance of a particular query plan.</p>
<blockquote>
<p>Bao æ˜¯æ€ä¹ˆè½¬æ¢ query plan trees: <strong>binarizing</strong> the query plan tree and encoding each query plan operator as a vector, optionally augmenting this representation with cache information</p>
</blockquote>
<p><strong>Binarization</strong>: Many queries involve non-binary operations like aggregation or sorting. However, <strong>strictly binary query plan trees</strong> (i.e., all nodes have either zero or two children) are convenient because they greatly <strong>simplify tree convolution</strong> (explained in the next section).</p>
<p><strong>Vectorization</strong>: Each node in a query plan tree is transformed into a vector containing: (1) a one-hot encoding of the operator, (2) cardinality and cost information, and optionally (3) cache information</p>
<blockquote>
<p>Tree convolutional neural networks</p>
</blockquote>
<p><strong>Integrating with Thompson sampling</strong>: ?</p>
<h3 id="training-loop">Training loop</h3>
<blockquote>
<p>æå‡ºäº†æ–°çš„ optimization, åœ¨äº‘å¹³å°ä¸Šå¯ä»¥çƒ­åŠ è½½ GPUï¼Ÿ</p>
</blockquote>
<h2 id="postgresql-integration">POSTGRESQL INTEGRATION</h2>
<p>install and use with PostgreSQL, hook system</p>
<p><strong>Per-query activation</strong>: sits on top of a traditional optimizer, When Bao is activated, Thompson sampling is used to select query hints. When Bao is deactivated, the PostgreSQL optimizer is used. Note that even when Bao is disabled, Bao can (optionally) still learn from query executions. <em>off-policy reinforcement learning</em> ??
<strong>Active vs. advisor mode</strong>: In active mode, Bao operates as described above, <strong>automatically selecting hint sets and learning from their performance</strong>. In advisor mode, Bao does not select hint sets (all queries are optimized by the PostgreSQL planner), but still observes the performance of executed queries and trains a predictive model.
<strong>Triggered exploration</strong>: query regressions, because Bao actively explores new query plans, regressions may be more <strong>erratic</strong></p>
<h2 id="related-works">RELATED WORKS</h2>
<p>One of the earliest applications of learning to query optimization was Leo [72], which used successive runs of the similar queries to adjust histogram estimators.</p>
<p>Neo [51] showed that <strong>deep reinforcement learning</strong> could be applied <strong>directly to query latency</strong>, and could learn optimization strategies that were competitive with commercial systems after 24 hours of training. However, none of these techniques are <strong>capable of handling changes in schema, data, or queryworkload</strong>, and none <strong>demonstrate</strong> improvement in <strong>tail performance</strong>. Works applying reinforcement learning to adaptive query processing have shown interesting results, but are not applicableto existing, non-adaptive systems like <strong>PostgreSQL</strong>.</p>
<blockquote>
<p>æˆ‘ä¸è®¤ä¸º Bao å’Œ Neo æœ‰å¤ªå¤§çš„å·®åˆ«ï¼ŒåŒæ ·éƒ½æ˜¯ RLï¼Œä¸ºä»€ä¹ˆè¯´ Neo æ— æ³•é€‚åº”å˜åŒ–å‘¢ï¼Ÿ</p>
</blockquote>
<h2 id="experiments">EXPERIMENTS</h2>
<p>real-world database <strong>workloads</strong>, quantifying not only query performance, but also on the <strong>dollar-cost</strong> of executing a workload</p>
<h3 id="setup">Setup</h3>
<p>IMDb dataset, new real-world datasets and workload called Stack, Corp dataset</p>
<blockquote>
<p>å®éªŒç»“æœåªæ˜¯å’Œ PG, ComSys æ¯”äº†ä¸€ä¸‹ latencyï¼Œæ•ˆæœè¿˜ä¸é”™ï¼Œå¤§æ¦‚ 20% çš„æ”¹å–„ï¼Œ P99 ä¹Ÿæ”¹å–„å¾ˆå¤šï¼Œä½†ä¸ºä»€ä¹ˆè¿™éƒ¨åˆ†ä¸å’Œ Neo å¯¹æ¯”å‘¢ï¼Ÿ</p>
</blockquote>
<p><strong>Query optimization time</strong>: The maximum optimization time required by PostgreSQL was 140ms, for the commercial system 165ms, and for <strong>Bao 230ms</strong>. For some applications, a 70ms increase in optimization time could be acceptable. Moreover, our current prototype is simple (e.g., our inference code is in Python), and thus a lot of optimization potential exists</p>
<blockquote>
<p>230ms æ¯”èµ· 140ms è™½ç„¶ä¸å¤šï¼Œä½†ä¹Ÿä¸ç®—å°‘å§ï¼Œè€Œä¸”ç”¨äº†å¤§é‡å¹¶è¡Œ</p>
</blockquote>
<p><strong>Prior learned optimizers</strong>: Neo [51] and DQ [40] are two other learning based approach to query optimization. Like Bao, Neo uses <strong>tree convolution</strong>, but unlike Bao, Neo <strong>does not select hint sets for specific queries</strong>, but instead fully builds query execution plans on its own. DQ uses deep Q learning [56] with a hand-crafted featurization and a fully-connected neural network (FCNN). We compare performance for the IMDb workload in Figure 14 (average of 20 repetitions on an N1-16 machine with a cutoff of 72 hours).</p>
<p>For Figure 14a, we uniformly at random select a query to create a stable workload, and for Figure 14b we use our original dynamic workload. <strong>With a stable workload, Neo is able to overtake PostgreSQL after 24 hours</strong>, and <strong>Bao after 65 hours</strong>. This is because Neo has many more degrees of freedom than Bao: Neo can use any logically correct query plan for any query, <strong>whereas Bao is limited to a small number of options</strong>. These degrees of freedom come at a cost, as Neo takes significantly longer to converge. After 200 hours of training, <strong>Neoâ€™s query performance was 15% higher than Baoâ€™s</strong>. DQ, with a similar degrees of freedom as Neo, takes longer to outperform PostgreSQL, possibly due to FCNNs having a poor inductive bias [50] for query optimization [51]. With the <strong>dynamic workload</strong> (Figure 14b), Neo and DQâ€™s convergence is significantly hampered, as both techniques struggle to learn a policy robust to the changing workload. With a dynamic workload, neither DQ nor Neo is able to overtake Bao within 72 hours.</p>
<blockquote>
<p>65h &gt; 24h ä¸ºä»€ä¹ˆ Bao ä¼šè¢« a small number of options é™åˆ¶å‘¢ï¼Œæ–‡ç« ä¹Ÿæ²¡æœ‰ä»”ç»†è§£é‡Š Bao æ˜¯æ€ä¹ˆé€‚åº” dynamic workload çš„</p>
</blockquote>
<p><img
        class="lazyload"
        src="../../svg/loading.min.svg"
        data-src="https://s2.loli.net/2024/03/18/dqC2A8ljWtbuI9L.png"
        data-srcset="https://s2.loli.net/2024/03/18/dqC2A8ljWtbuI9L.png, https://s2.loli.net/2024/03/18/dqC2A8ljWtbuI9L.png 1.5x, https://s2.loli.net/2024/03/18/dqC2A8ljWtbuI9L.png 2x"
        data-sizes="auto"
        alt="https://s2.loli.net/2024/03/18/dqC2A8ljWtbuI9L.png"
        title="https://s2.loli.net/2024/03/18/dqC2A8ljWtbuI9L.png" /></p>
<h2 id="conclusion-and-future-work">CONCLUSION AND FUTURE WORK</h2>
<blockquote>
<p>å®é™…ä¸Š Bao å›¢é˜Ÿå’Œ Neo å›¢é˜Ÿéƒ½æ˜¯ä¸€æ‰¹äººï¼Œåº”è¯¥æ˜¯æ³¨é‡ç‚¹ä¸å¤ªä¸€æ ·ï¼š</p>
<p>Neo æ˜¯ç¬¬ä¸€ä¸ªæå‡ºæ·±åº¦å­¦ä¹  query optimizer çš„ï¼Œç”¨ä¸€ä¸ªæœªè¡¥å…¨çš„ query plan encoding ä¹‹åç”¨æ ‘å½¢ç½‘ç»œåšé¢„æµ‹ costï¼Œå¹¶ç”¨æœ€å°å †æœç´¢æœ€ä¼˜ planï¼Œå¿½ç•¥ cardinality ç­‰ç­‰ä¼ ç»Ÿï¼Œä¸ºæ¯ä¸ª predicate ç”¨æµ®ç‚¹æ•°å­˜ feature è®¾è®¡ word vector å­˜è¯­ä¹‰ï¼Œå¯èƒ½å¥½äº histgram é¢„æµ‹ã€‚ä½†ç¼ºç‚¹æ˜¯è®­ç»ƒæ—¶é—´é•¿ï¼Œåªåœ¨å¹³å‡ä¸Šæå‡æ¯”è¾ƒå¥½ï¼Œé«˜è´¨é‡çš„è®¡åˆ’å¾ˆå¯èƒ½åœ¨éšæœºæ ·æœ¬ä¸­ç¼ºå¤±ï¼Œæ ·æœ¬é‡å¿…é¡»å¤§ï¼Œæ¨¡å‹è®­ç»ƒæˆæœ¬å¤ªé«˜ã€‚</p>
</blockquote>
<blockquote>
<p>è€Œ Bao æ”¾å¼ƒåš Optimizerï¼Œä¸ºæˆç†Ÿæ•°æ®åº“æä¾› query hints å¦‚ boolean flag è¡¨ç¤ºæ˜¯å¦ä½¿ç”¨ hash join, merge join, index scan ç­‰ç­‰ï¼Œæšä¸¾æ‰€æœ‰ hint set (access method + join method) è§†ä½œå¤šè‡‚è€è™æœºï¼Œç”¨ Thompson sampling å¹³è¡¡é€‰ä¸€ä¸ªæœ€ä¼˜çš„ã€‚è®ºæ–‡æåˆ°äº† Bao æ”¶æ•›å¿«äº Neoï¼Œå¿«å¾ˆå¤šï¼Œè€Œä¸”å¯ä»¥æ ¹æ® workload è°ƒæ•´ï¼Œåœ¨ JOB æ•°æ®é›†ä¸Šè¡¨ç°éå¸¸å¥½ï¼Œä½†è¿˜æ˜¯å¯èƒ½ä¼šå»æ‰ä¸€äº›æœ€ä¼˜çš„ï¼Œé€‰æ‹©æ¬¡ä¼˜çš„ã€‚</p>
<p>å»å¹´ä¹Ÿæœ‰ä¸€ç¯‡ Leroï¼Œé‡‡ç”¨æˆå¯¹æ–¹æ³•è®­ç»ƒåˆ†ç±»å™¨ï¼Œä¹Ÿä¸æ˜¯ä»å¤´å¼€å§‹ï¼Œå¾ˆç±»ä¼¼ã€‚å°è¯•è§£å†³ Bao çš„ä¸€äº›é—®é¢˜: 1. åœ¨æ•´ä¸ªè®¡åˆ’æœç´¢è¿‡ç¨‹ä¸­ï¼Œé€šå¸¸å¯¹<strong>æ•´ä¸ªæŸ¥è¯¢</strong>åº”ç”¨æç¤ºé›†ã€‚å¦‚æœæŸ¥è¯¢çš„ä¸åŒéƒ¨åˆ†ï¼ˆå­æŸ¥è¯¢ï¼‰å…·æœ‰ä¸åŒçš„æœ€ä½³é€‰æ‹©ï¼Œåˆ™åœ¨æŸ¥è¯¢çº§åˆ«è°ƒæ•´æ ‡å¿—å¯èƒ½ä¼šé”™è¿‡å¯»æ‰¾é«˜è´¨é‡è®¡åˆ’çš„æœºä¼š 2. å¯ç”¨çš„æç¤ºé›†æ˜¯<strong>ç‰¹å®šäºç³»ç»Ÿ</strong>çš„ã€‚ä¼˜åŒ–å™¨é€šå¸¸åŒ…å«æ•°ç™¾ä¸ªæ ‡å¿—æ¥å®ç°/ç¦ç”¨æŸäº›ä¼˜åŒ–è§„åˆ™ã€‚åœ¨å®è·µä¸­<strong>æšä¸¾å„ç§ç»„åˆæ˜¯ä¸å¯è¡Œ</strong>çš„ã€‚æ‰‹åŠ¨é€‰æ‹©æç¤ºé›†çš„æœ‰æ•ˆå­é›†éœ€è¦å¯¹ç³»ç»Ÿè¿›è¡Œæ·±å…¥çš„ç†è§£ï¼Œå¹¶å¯¹å·¥ä½œè´Ÿè½½è¿›è¡Œç»¼åˆåˆ†æã€‚</p>
<p>Lero ç”šè‡³å®ç°äº†ä¸€ä¸ª Bao+, ç”¨æ›´å¤šè®¡åˆ’è¿›è¡Œæ¨¡å‹è®­ç»ƒï¼Œä½†å¥½åƒæ²¡æœ‰ä»”ç»†è¯´ã€‚åŒæ—¶æ‹“å±•äº†æ›´å¤šçš„æ•°æ®é›†ï¼Œ IMDBï¼ŒJOBï¼ŒSTATSï¼ŒTPC-Hï¼ŒTPC-DSï¼Œç­‰ç­‰</p>
</blockquote>
<h2 id="paer-reading">Paer Reading</h2>
<blockquote>
<p>The paper proposes a more practical model called Bao, which sits on top of an existing query optimizer (PostgreSQL) and utilizes machine learning and reinforcement learning for database query optimization. Bao solves lots of the issues with previous learned optimizers, including long training times, inability to adapt, and being difficult to interpret while offers advantages like faster training, robustness to workload and data changes, and better interpretability. The core idea of Bao is to utilize tree convolutional neural networks to analyze query plans and leverage ML techniques called Multi-armed bandit and Thompson Sampling to choose the best query plan among alternatives.</p>
</blockquote>
<blockquote>
<ol>
<li>Bao addresses a major limitation of previous learned optimizers â€“ long training times. By employing Thompson Sampling to solve bandit problem, Bao significantly reduces training time compared to traditional machine learning methods used for query optimization, and achieves similar performance to PostgreSQL in 2 hours training.</li>
<li>Bao is more robust to changes in schema, data distribution, and query workload. By combining modern tree convolutional neural networks and Thompson sampling to provide query hints, Bao offers interpretability unlike other black-box machine learning models and aims to reduce tail latency and minimize the occurrence of slow-running queries.</li>
<li>The paper also proposes a new method to optimize resource usage in cloud environments, specifically for tasks involving training a neural network with GPU and then using it for query optimization with CPU, which can reduce overall costs.</li>
</ol>
</blockquote>
<blockquote>
<ol>
<li>Bao uses Thompson Sampling to enumerate all hint sets in the multi-armed bandit problem, but during the searching process, the hint set is applied to the entire query. If different parts of the query (subqueries) have different best choices, it will lead to the final choice is not optimal.</li>
<li>Enumerating all collections is very time-consuming, the query optimization time of Bao is nearly 90ms higher than PostgreSQL. And for different systems, the size of the hint sets may be different, somtimes it might include hundreds of boolean flags.</li>
<li>The architectures of Bao and Neo look very similar, though the authors of these papers are from the same group, the paper does not carefully compare Neo and Bao, especially the performance of training time and query latency.</li>
</ol>
</blockquote>
<blockquote>
<p>First, I would explain the difference between Neo and Bao in more depth, for example, why they all use modern tree convolutional neural networks. Besides, I will collect more data sets and testing their performance on more data benchmarks (such as TPC-H, TPC-DS, STATS). If possible, I would try some methods to limit the hint sets to reduce the current query optimization time, such as manual selection or from expert experiences.</p>
</blockquote>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>æ›´æ–°äº 2024-03-17</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="åˆ†äº«åˆ° Twitter" data-sharer="twitter" data-url="https://ad-bean.github.io/posts/bao-learned-query-opt/" data-title="Paper Reading: Bao: Making Learned Query Optimization Practical [SIGMOD 21]" data-hashtags="Paper Reading"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="åˆ†äº«åˆ° Facebook" data-sharer="facebook" data-url="https://ad-bean.github.io/posts/bao-learned-query-opt/" data-hashtag="Paper Reading"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="åˆ†äº«åˆ° Hacker News" data-sharer="hackernews" data-url="https://ad-bean.github.io/posts/bao-learned-query-opt/" data-title="Paper Reading: Bao: Making Learned Query Optimization Practical [SIGMOD 21]"><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="åˆ†äº«åˆ° Line" data-sharer="line" data-url="https://ad-bean.github.io/posts/bao-learned-query-opt/" data-title="Paper Reading: Bao: Making Learned Query Optimization Practical [SIGMOD 21]"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="åˆ†äº«åˆ° å¾®åš" data-sharer="weibo" data-url="https://ad-bean.github.io/posts/bao-learned-query-opt/" data-title="Paper Reading: Bao: Making Learned Query Optimization Practical [SIGMOD 21]"><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="../../tags/paper-reading/">Paper Reading</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">è¿”å›</a></span>&nbsp;|&nbsp;<span><a href="../../">ä¸»é¡µ</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="../../posts/zero-shot-learned/" class="prev" rel="prev" title="Paper Reading: Zero-Shot Cost Models for Out-of-the-box Learned Cost Prediction [VLDB 2022]"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>Paper Reading: Zero-Shot Cost Models for Out-of-the-box Learned Cost Prediction [VLDB 2022]</a>
            <a href="../../posts/minilsm-1/" class="next" rel="next" title="Mini-LSM Week 1 Day1">Mini-LSM Week 1 Day1<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">ç”± <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.129.0">Hugo</a> å¼ºåŠ›é©±åŠ¨ | ä¸»é¢˜ - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden="true"></i> LoveIt</a>
                </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2022 - 2024</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://github.com/ad-bean" target="_blank">Adbean</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="å›åˆ°é¡¶éƒ¨">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="æŸ¥çœ‹è¯„è®º">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/algoliasearch@4.13.1/dist/algoliasearch-lite.umd.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"å¤åˆ¶åˆ°å‰ªè´´æ¿","maxShownLines":50},"comment":{},"search":{"algoliaAppID":"OKDXG1V1ML","algoliaIndex":"blog","algoliaSearchKey":"d36cbd4755f8bf0c3fc49bb46f4b8f8a","highlightTag":"em","maxResultLength":10,"noResultsFound":"æ²¡æœ‰æ‰¾åˆ°ç»“æœ","snippetLength":50,"type":"algolia"}};</script><script type="text/javascript" src="../../js/theme.min.js"></script></body>
</html>
